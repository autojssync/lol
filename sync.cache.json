{"last_sync":"1517476826917","t1517475287694859952":{"_id":"t1517475287694859952","body":"const {ipcRenderer} = require('electron');\nconst loading       = require('./assets/loading_scene');\nconst _             = require('lodash');\nconst moment        = require('moment');\nconst fs            = require('fs');\nconst request       = require('request');\n\nlet list     = {};\nlet syncData = {};\nlet running  = false;\nlet isSync   = false;\n\n$(document).ready(() => {\n  loading.show();\n  ipcRenderer.send('sync', true);\n  isSync = true;\n  ipcRenderer.on('sync', (event, arg) => {\n    syncData = arg;\n    isSync   = false;\n    // alert(JSON.stringify(arg, null, 2));\n    list     = {};\n    loading.hide();\n    $('#list').empty();\n    if(Object.keys(arg).length===0) {\n      addScript('', 'Untitled', '', '');\n    } else {\n      let poiter = '';\n      arg        = _.orderBy(arg, ['_id'], ['desc']);\n      _.forEach(arg, (item) => {\n        if(item.name) {\n          if(poiter==='') poiter = item._id;\n          list[item._id] = item;\n          $('#list').append(`<li onclick=\"detail('${item._id}')\"><a href=\"#\" data-id=\"${item._id}\">${item.name}</a></li>`);\n        }\n      });\n      detail(list[current] ? current : poiter);\n    }\n  });\n  ipcRenderer.on('run', (event, arg) => {\n    if(arg.type==='stop') {\n      running = false;\n      $('#status').html(`[${arg.name}] đã dừng.`);\n    }\n  });\n  ipcRenderer.on('sync-up', (event, arg) => {\n    syncData.last_sync = arg;\n    loading.hide();\n  });\n  // ----------\n  $('#sync').click(() => {\n    sync();\n  });\n  $('#sync-up').click(() => {\n    loading.show();\n    ipcRenderer.send('sync-up');\n  });\n  $('.selection').click(function() {\n    $(this).select();\n  });\n  $('#save').click(() => {\n    addScript($('#id').val(), $('#code-name').val(), $('#code-body').val(), $('#code-close').val());\n  });\n  $('#delete').click(() => {\n    if(confirm('Xác nhận xóa?')) {\n      loading.show();\n      ipcRenderer.send('detete', $('#id').val());\n    }\n  });\n  $('#add-script').click(() => {\n    current = '';\n    addScript('', 'Untitled', '', '');\n  });\n  $('#run').click(() => {\n    if(running) return alert('Có mã đang chạy...');\n    running = true;\n    $('#status').html(`[${$('#code-name').val()}] đang chạy. <a onclick=\"stopScript()\">[DỪNG]</a>`);\n    ipcRenderer.send('run', {\n      _id:   $('#id').val(),\n      name:  $('#code-name').val(),\n      body:  $('#code-body').val(),\n      close: $('#code-close').val()\n    });\n  });\n  // sync interval\n  let syncTime = 3000;\n  let autoSync = () => {\n    if(syncData.last_sync && !loading.isShow) {\n      request('http://textuploader.com/dh1wr/raw', (err, res, body) => {\n        if(body && body!=='null') {\n          if(parseInt(syncData.last_sync)!==parseInt(body.replace(/\\\"/g, ''))) {\n            if(!loading.isShow) {\n              $('#sync').click();\n            }\n          }\n        }\n        setTimeout(() => {\n          autoSync();\n        }, syncTime);\n      });\n    } else {\n      setTimeout(() => {\n        autoSync();\n      }, syncTime);\n    }\n  };\n  autoSync();\n});\n\nconst stopScript = () => {\n  $('#status').html(`Đang dừng...`);\n  ipcRenderer.send('run', {\n    type: 'stop'\n  });\n};\n\nconst sync = () => {\n  isSync = true;\n  loading.show();\n  ipcRenderer.send('sync');\n};\n\nconst addScript = (id, name, body, close) => {\n  loading.show();\n  ipcRenderer.send('add', {\n    id, name, body, close\n  });\n};\n\nlet current  = '';\nconst detail = (id) => {\n  let item = list[id];\n  if(item) {\n    current = id;\n    $('#code-name').val(item.name);\n    $('#code-body').val(item.body);\n    $('#code-close').val(item.close);\n    $('#id').val(id);\n    $('#list a').css('color', '#ccc');\n    $(`a[data-id=\"${id}\"]`).css('color', '#337ab7');\n  } else {\n    $('#code-name').val('Chưa chọn');\n    $('#code-body').val('');\n    $('#code-close').val('');\n    $('#id').val('');\n  }\n};","close":"","name":"dng"}}
